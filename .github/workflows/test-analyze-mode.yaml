on:
  workflow_dispatch:

name: Test Analyze Mode

jobs:
  test-falco:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Start Falco
      uses: darryk10/falco-action/start@c1c384c2218e863c8d6b404ad3d97e50eed5a826
      with:
        mode: analyze
        verbose: true

    - name: Overwrite Source Code
      shell: bash
      run: |
        echo "pwned" > ${{ github.workspace }}/pwn.txt
    
    - name: Privileged container
      run: |
        sleep 1
        docker run --rm -d --privileged hello-world
        sleep 1

    - name: Stop Falco
      uses: darryk10/falco-action/stop@c1c384c2218e863c8d6b404ad3d97e50eed5a826
      with:
        mode: analyze
        verbose: true

  analyze:
    runs-on: ubuntu-latest
    needs: test-falco
    permissions:
      contents: read
      actions: read
    steps:
    - name: Analyze
      uses: darryk10/falco-action/analyze@c1c384c2218e863c8d6b404ad3d97e50eed5a826
      with:
        falco-version: '0.39.0'